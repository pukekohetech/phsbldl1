<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Student Task with PDF & Email</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 1rem;
      line-height: 1.5;
      background: #fafafa;
      color: concierge #333;
    }
    h1, h2, h3 {
      text-align: center;
      color: #2c3e50;
    }
    label {
      display: block;
      margin-top: 0.75rem;
      font-weight: bold;
    }
    input[type="text"], textarea, select {
      width: 100%;
      box-sizing: border-box;
      padding: 0.5rem;
      margin-top: 0.25rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: inherit;
    }
    button {
      margin-top: 1rem;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      color: white;
    }
    button:hover { opacity: 0.9; }
    .button-row {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 1rem;
    }
    .question-block {
      margin-top: 1rem;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .hidden { display: none; }
    hr {
      margin: 1.5rem 0;
      border: 0;
      border-top: 1px solid #eee;
    }
    .note {
      font-size: 0.9rem;
      color: #555;
      background: #f0f8ff;
      padding: 0.75rem;
      border-radius: 4px;
      border-left: 4px solid #3498db;
    }
    pre {
      white-space: pre-wrap;
      background: #f5f5f5;
      padding: 0.75rem;
      border-radius: 4px;
      border: 1px solid #ddd;
      font-family: monospace;
      max-height:300px;
      overflow-y:auto;
    }
    #clear-button { background: #e74c3c; }
    #email-button { background: #27ae60; }
    #grade-button { background: #9b59b6; }
    #pdf-button { background: #e67e22; }
    .no-print { print-color-adjust: exact; }
    .grade-box {
      margin-top: 2rem;
      padding: 1rem;
      background: #f9f9ff;
      border: 2px solid #9b59b6;
      border-radius: 8px;
    }
    @media print {
      body { background: white; }
      .no-print, .grade-box button { display: none; }
      pre, .grade-box { border: 1px solid #aaa; page-break-inside: avoid; }
    }
  </style>
</head>
<body>
  <h1>Student Task with PDF & Email</h1>

  <!-- FORM VIEW -->
  <div id="form-view">
    <p class="note">
      Answer the questions, get graded, and send your work to your teacher!
    </p>

    <form id="task-form">
      <label>Student ID: <span style="color:red">*</span>
        <input type="text" name="studentId" id="studentId" required />
      </label>

      <label>Teacher: <span style="color:red">*</span>
        <select id="teacherSelect" name="teacherId" required></select>
      </label>

      <label>Task: <span style="color:red">*</span>
        <select id="taskSelect" name="taskId" required></select>
      </label>

      <div class="button-row no-print">
        <button type="button" id="load-button">Load Saved Work</button>
        <button type="button" id="clear-button">Clear All Data</button>
      </div>

      <label>Student Name: <span style="color:red">*</span>
        <input type="text" name="studentName" id="studentName" required />
      </label>

      <label>Class / Subject:
        <input type="text" name="className" id="className" />
      </label>

      <div id="questions-container"></div>

      <div class="button-row no-print">
        <button type="submit">Generate Summary (and Save)</button>
        <button type="button" id="save-only-button">Save Progress</button>
        <button type="button" id="email-button">Submit to Teacher (Email + PDF)</button>
      </div>
    </form>
  </div>

  <!-- SUMMARY VIEW -->
  <div id="summary-view" class="hidden">
    <h2>Student Response Summary</h2>
    <p id="summary-header" style="font-weight:bold; text-align:center;"></p>
    <div id="summary-questions"></div>

    <hr />

    <p class="note">
      Download your graded work or email it to your teacher.
    </p>

    <h3>Copyable Text</h3>
    <pre id="copyable-text"></pre>

    <div class="button-row no-print">
      <button id="back-button">Edit Answers</button>
      <button id="print-button">Print / Save as PDF</button>
      <button id="grade-button">Auto-Grade</button>
      <button id="pdf-button">Download PDF</button>
    </div>
  </div>

  <!-- Load Data -->
  <script src="questions.js"></script>

  <!-- App Logic -->
  <script>
    const { jsPDF } = window.jspdf;
    const STORAGE_PREFIX = "student_task_";
    const taskSelect = document.getElementById("taskSelect");
    const teacherSelect = document.getElementById("teacherSelect");
    const questionsContainer = document.getElementById("questions-container");
    const formView = document.getElementById("form-view");
    const summaryView = document.getElementById("summary-view");

    if (!TASKS || TASKS.length === 0) throw new Error("TASKS missing");
    if (!TEACHERS || TEACHERS.length === 0) throw new Error("TEACHERS missing");

    TEACHERS.forEach(t => {
      const opt = document.createElement("option");
      opt.value = t.id; opt.textContent = t.name;
      teacherSelect.appendChild(opt);
    });
    TASKS.forEach(task => {
      const opt = document.createElement("option");
      opt.value = task.id; opt.textContent = task.name;
      taskSelect.appendChild(opt);
    });

    function getCurrentTask() {
      return TASKS.find(t => t.id === taskSelect.value) || TASKS[0];
    }

    function getStorageKey() {
      const id = (document.getElementById("studentId").value || "").trim();
      const task = getCurrentTask();
      return id ? `${STORAGE_PREFIX}${id}_${task.id}` : null;
    }

    function renderQuestions(task, answers = {}) {
      questionsContainer.innerHTML = "";
      task.questions.forEach((q, i) => {
        const block = document.createElement("div");
        block.className = "question-block";
        const label = document.createElement("label");
        label.innerHTML = `<strong>Q${i + 1}:</strong> ${q.text} <em>(${q.maxPoints} pts)</em>`;

        const input = q.type === "long" ? document.createElement("textarea") : document.createElement("input");
        input.type = q.type !== "long" ? "text" : undefined;
        input.rows = q.type === "long" ? 4 : undefined;
        input.name = `q_${q.id}`;
        input.required = true;
        input.value = answers[q.id] || "";

        label.appendChild(document.createElement("br"));
        label.appendChild(input);
        block.appendChild(label);
        questionsContainer.appendChild(block);
      });
    }

    renderQuestions(getCurrentTask());

    taskSelect.addEventListener("change", () => {
      const saved = localStorage.getItem(getStorageKey());
      const map = saved ? JSON.parse(saved).answers.reduce((a, c) => (a[c.id] = c.answer, a), {}) : {};
      renderQuestions(getCurrentTask(), map);
    });

    function collectFormData() {
      const fd = new FormData(document.getElementById("task-form"));
      const studentId = (fd.get("studentId") || "").trim();
      const studentName = (fd.get("studentName") || "").trim();
      const className = (fd.get("className") || "").trim();
      const task = getCurrentTask();

      if (!studentId || !studentName) {
        alert("Student ID and Name required.");
        return null;
      }

      const answers = task.questions.map(q => ({
        id: q.id,
        question: q.text,
        answer: (fd.get(`q_${q.id}`) || "").trim()
      }));

      return { studentId, studentName, className, taskId: task.id, taskName: task.name, answers };
    }

    let lastData = null;
    let lastGradeResult = null;

    function generateSummary(data) {
      lastData = data;
      const teacher = TEACHERS.find(t => t.id === teacherSelect.value);
      document.getElementById("summary-header").textContent =
        `${data.studentName} (${data.studentId}) → ${teacher?.name || "Teacher"} — ${data.taskName}`;

      const container = document.getElementById("summary-questions");
      container.innerHTML = "";
      data.answers.forEach((a, i) => {
        const div = document.createElement("div");
        div.className = "question-block";
        div.innerHTML = `<strong>Q${i + 1}:</strong> ${a.question}<br><em>${a.answer || "(No answer)"}</em>`;
        container.appendChild(div);
      });

      let text = `Student: ${data.studentName} (${data.studentId})\n`;
      text += `Teacher: ${teacher?.name || "N/A"}\n`;
      text += `Task: ${data.taskName}\n`;
      text += `Class: ${data.className || "N/A"}\n\n`;
      data.answers.forEach((a, i) => {
        text += `Q${i + 1}: ${a.question}\nAnswer: ${a.answer || "(No answer)"}\n\n`;
      });
      if (lastGradeResult) {
        text += `--- AUTO-GRADE ---\n${lastGradeResult.full}\n`;
      }
      document.getElementById("copyable-text").textContent = text;

      formView.classList.add("hidden");
      summaryView.classList.remove("hidden");
    }

    document.getElementById("task-form").addEventListener("submit", e => {
      e.preventDefault();
      const data = collectFormData();
      if (!data) return;
      const key = getStorageKey();
      if (key) localStorage.setItem(key, JSON.stringify(data));
      generateSummary(data);
    });

    document.getElementById("save-only-button").addEventListener("click", () => {
      const data = collectFormData();
      if (!data) return;
      const key = getStorageKey();
      if (key) {
        localStorage.setItem(key, JSON.stringify(data));
        alert("Saved!");
      }
    });

    document.getElementById("load-button").addEventListener("click", () => {
      const key = getStorageKey();
      if (!key) { alert("Enter Student ID."); return; }
      const raw = localStorage.getItem(key);
      if (!raw) { alert("No saved work."); return; }
      const data = JSON.parse(raw);
      document.getElementById("studentId").value = data.studentId;
      document.getElementById("studentName").value = data.studentName;
      document.getElementById("className").value = data.className || "";
      taskSelect.value = data.taskId;
      teacherSelect.value = data.teacherId || TEACHERS[0].id;
      const map = {};
      data.answers.forEach(a => map[a.id] = a.answer);
      renderQuestions(TASKS.find(t => t.id === data.taskId), map);
      alert("Loaded!");
    });

    // === AUTO-GRADING ===
    function autoGrade(data) {
      const task = TASKS.find(t => t.id === data.taskId);
      if (!task || !task.totalPoints) return null;

      let totalEarned = 0;
      const feedback = [];

      data.answers.forEach(ans => {
        const q = task.questions.find(q => q.id === ans.id);
        if (!q || !q.rubric) {
          feedback.push(`Q${task.questions.indexOf(q) + 1}: Manual review needed.`);
          return;
        }

        let earned = 0;
        const hints = [];
        q.rubric.forEach(rule => {
          if (rule.check.test(ans.answer)) {
            earned += rule.points;
          } else {
            hints.push(rule.hint);
          }
        });
        earned = Math.min(earned, q.maxPoints);
        totalEarned += earned;

        const good = earned >= q.maxPoints * 0.8 ? "Great!" : earned > 0 ? "Good start!" : "";
        const improve = hints.length > 0 ? `Try: ${hints[0]}` : "Perfect!";

        feedback.push(`**Q${task.questions.indexOf(q) + 1}: ${earned}/${q.maxPoints}**  
${good}  
${improve}`);
      });

      const pct = ((totalEarned / task.totalPoints) * 100).toFixed(0);
      const grade = totalEarned >= task.totalPoints * 0.9 ? "A" :
                    totalEarned >= 0.8 ? "B" :
                    totalEarned >= 0.7 ? "C" :
                    totalEarned >= 0.6 ? "D" : "F";

      return {
        score: `${totalEarned}/${task.totalPoints}`,
        grade, percentage: `${pct}%`,
        feedback: feedback.join("\n\n"),
        full: `Score: ${totalEarned}/${task.totalPoints} (${grade}, ${pct}%)\n\n${feedback.join("\n\n")}`
      };
    }

    document.getElementById("grade-button").addEventListener("click", () => {
      if (!lastData) return;
      const result = autoGrade(lastData);
      if (!result) { alert("No rubric."); return; }

      lastGradeResult = result;
      lastData.gradeResult = result;

      const container = document.getElementById("summary-questions");
      const existing = container.querySelector(".grade-box");
      if (existing) existing.remove();

      const box = document.createElement("div");
      box.className = "grade-box";
      box.innerHTML = `
        <h3>Auto-Grade Result</h3>
        <p><strong>${result.score}</strong> → <strong>${result.grade}</strong> (${result.percentage})</p>
        <pre style="background:#fff;padding:1rem;margin:0.5rem 0 0;border:1px solid #ddd;">${result.feedback}</pre>
        <button onclick="navigator.clipboard.writeText('${result.full.replace(/'/g, "\\'")}')" 
                style="margin-top:0.5rem;background:#8e44ad;">Copy Feedback</button>
      `;
      container.appendChild(box);
    });

    // === PDF GENERATION ===
    async function generatePDF() {
      if (!lastData) return null;
      const teacher = TEACHERS.find(t => t.id === teacherSelect.value);
      const { score = "", grade = "", percentage = "", feedback = "" } = lastGradeResult || {};

      const doc = new jsPDF();
      let y = 20;
      const lineHeight = 7;

      doc.setFontSize(16);
      doc.text(`${lastData.studentName} - ${lastData.taskName}`, 105, y, { align: "center" });
      y += 10;
      doc.setFontSize(12);
      doc.text(`ID: ${lastData.studentId} | Class: ${lastData.className || "N/A"}`, 105, y, { align: "center" });
      y += 10;
      doc.text(`Teacher: ${teacher?.name || "N/A"}`, 105, y, { align: "center" });
      y += 15;

      if (lastGradeResult) {
        doc.setFontSize(14);
        doc.text(`Grade: ${score} (${grade}, ${percentage})`, 105, y, { align: "center" });
        y += 15;
      }

      doc.setFontSize(11);
      lastData.answers.forEach((a, i) => {
        if (y > 270) { doc.addPage(); y = 20; }
        doc.setFont("helvetica", "bold");
        doc.text(`Q${i + 1}: ${a.question}`, 15, y);
        y += lineHeight;
        doc.setFont("helvetica", "normal");
        const lines = doc.splitTextToSize(a.answer || "(No answer)", 180);
        lines.forEach(line => {
          if (y > 280) { doc.addPage(); y = 20; }
          doc.text(line, 20, y);
          y += lineHeight;
        });
        y += 5;
      });

      if (lastGradeResult) {
        if (y > 250) { doc.addPage(); y = 20; }
        doc.setFont("helvetica", "bold");
        doc.text("AUTO-GRADE FEEDBACK", 15, y);
        y += lineHeight;
        doc.setFont("helvetica", "normal");
        const fbLines = doc.splitTextToSize(feedback, 180);
        fbLines.forEach(line => {
          if (y > 280) { doc.addPage(); y = 20; }
          doc.text(line, 20, y);
          y += lineHeight;
        });
      }

      const pdfBlob = doc.output('blob');
      const base64 = await blobToBase64(pdfBlob);
      return { blob: pdfBlob, base64, filename: `${lastData.studentId}_${lastData.taskName.replace(/ /g, "_")}.pdf` };
    }

    function blobToBase64(blob) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result.split(',')[1]);
        reader.readAsDataURL(blob);
      });
    }

    document.getElementById("pdf-button").addEventListener("click", async () => {
      const pdf = await generatePDF();
      if (!pdf) { alert("Generate summary first."); return; }
      const url = URL.createObjectURL(pdf.blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = pdf.filename;
      a.click();
      URL.revokeObjectURL(url);
    });

    // === SUBMIT TO TEACHER (EMAIL + PDF) ===
    document.getElementById("email-button").addEventListener("click", async () => {
      const data = collectFormData();
      if (!data) return;

      // Save first
      const key = getStorageKey();
      if (key) localStorage.setItem(key, JSON.stringify(data));

      const teacher = TEACHERS.find(t => t.id === teacherSelect.value);
      if (!teacher || !teacher.email) {
        alert("Please select a teacher with a valid email.");
        return;
      }

      // Generate PDF
      const pdf = await generatePDF();
      if (!pdf) {
        alert("Please generate summary first.");
        return;
      }

      // Email body
      const subject = encodeURIComponent(`${data.studentName} - ${data.taskName}`);
      let body = `Hi ${teacher.name},\n\n`;
      body += `Please find my completed work attached as a PDF.\n\n`;
      body += `Student: ${data.studentName} (${data.studentId})\n`;
      body += `Task: ${data.taskName}\n`;
      if (lastGradeResult) body += `Auto-Grade: ${lastGradeResult.score} (${lastGradeResult.grade})\n`;
      body += `\nThank you!\n`;

      const encodedBody = encodeURIComponent(body);
      const attachment = `data:application/pdf;base64,${pdf.base64}`;

      // Open email client with attachment
      const mailto = `mailto:${teacher.email}?subject=${subject}&body=${encodedBody}&attachment=${attachment}`;
      window.location.href = mailto;

      alert(`Opening your email app with PDF attached to ${teacher.name}...`);
    });

    // Navigation
    document.getElementById("back-button").addEventListener("click", () => {
      summaryView.classList.add("hidden");
      formView.classList.remove("hidden");
    });
    document.getElementById("print-button").addEventListener("click", () => window.print());
    document.getElementById("clear-button").addEventListener("click", () => {
      if (confirm("Clear all saved work?")) {
        localStorage.clear();
        alert("All data cleared.");
      }
    });

    // Save data for grading
    const origGen = generateSummary;
    generateSummary = function(data) {
      lastData = data;
      origGen(data);
    };
  </script>
</body>
</html>