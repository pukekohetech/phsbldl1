<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BCATS Student Submission</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {font-family:'Segoe UI',Arial,sans-serif;max-width:900px;margin:2rem auto;padding:1rem;background:#f8f9fa;color:#2c3e50;}
    h1 {text-align:center;color:#2c3e50;}
    .subtitle {text-align:center;color:#636e72;font-size:1.1rem;margin-bottom:2rem;}
    .big-btn{display:block;width:100%;padding:1.2rem;margin:1rem 0;font-size:1.3rem;font-weight:bold;
      border:none;border-radius:12px;color:white;cursor:pointer;box-shadow:0 6px 20px rgba(0,0,0,0.2);transition:all .2s;}
    .big-btn:hover{transform:translateY(-4px);box-shadow:0 10px 25px rgba(0,0,0,0.3);}
    .btn-blue{background:#3498db;}.btn-purple{background:#9b59b6;}.btn-green{background:#27ae60;}
    .btn-orange{background:#e67e22;}.btn-gray{background:#95a5a6;}
    label{display:block;margin-top:1.2rem;font-weight:bold;color:#2c3e50;}
    input,textarea,select{width:100%;padding:0.9rem;margin-top:0.4rem;border:2px solid #ddd;border-radius:8px;font-size:1rem;}
    .question-block{background:white;padding:1.2rem;border-radius:10px;margin:1.5rem 0;box-shadow:0 3px 12px rgba(0,0,0,0.1);}
    .hidden{display:none;}
    .note{background:#e3f2fd;padding:1rem;border-left:5px solid #3498db;border-radius:8px;margin:1.5rem 0;}
    .authenticity{background:#fff3cd;padding:1rem;border-left:5px solid #f39c12;border-radius:8px;margin:1.5rem 0;font-weight:bold;text-align:center;}
    #grade-box{background:#d5f4e6;padding:1.2rem;border-left:5px solid #27ae60;border-radius:10px;font-size:1.4rem;text-align:center;margin:2rem 0;}
  </style>
</head>
<body>

  <h1>BCATS Student Submission</h1>
  <p class="subtitle">Answer → Auto-Grade → Email Teacher with PDF</p>

  <!-- FORM VIEW -->
  <div id="form-view">
    <div class="note">Fill in your details and answers – everything auto-saves!</div>

    <form id="task-form">
      <label>Student ID: <span style="color:red">*</span></label>
      <input type="text" id="studentId" required />

      <label>Full Name: <span style="color:red">*</span></label>
      <input type="text" id="studentName" required />

      <label>Teacher:</label>
      <select id="teacherSelect" required></select>

      <label>Task:</label>
      <select id="taskSelect" required></select>

      <label>Class (optional):</label>
      <input type="text" id="className" placeholder="e.g. 11BCAT" />

      <div id="questions-container">Loading questions…</div>

      <div class="authenticity">
        Type the word "<span id="secret-word">…</span>" to prove this is your own work:
        <input type="text" id="auth-check" placeholder="type secret word here" style="margin-top:8px;" />
      </div>

      <button type="button" id="load-btn" class="big-btn btn-blue">Load Saved Work</button>
      <button type="submit" class="big-btn btn-purple">Submit & Auto-Grade</button>
      <button type="button" id="email-btn1" class="big-btn btn-green">Email Teacher with PDF</button>
    </form>
  </div>

  <!-- SUMMARY VIEW -->
  <div id="summary-view" class="hidden">
    <h2>All Done!</h2>
    <div id="summary-header" style="text-align:center;font-size:1.4rem;margin:1.5rem 0;"></div>
    <div id="grade-box">Calculating grade…</div>
    <div id="summary-questions"></div>

    <button id="back-btn" class="big-btn btn-gray">Edit Answers</button>
    <button id="pdf-btn" class="big-btn btn-orange">Download PDF</button>
    <button id="email-btn2" class="big-btn btn-green">Email Teacher Now</button>
  </div>

  <!-- Load questions.js first -->
  <script src="questions.js"></script>

  <!-- Main app – runs only after questions.js is loaded -->
  <script>
    // Safety check
    if (typeof TEACHERS === "undefined" || typeof TASKS === "undefined") {
      document.getElementById("questions-container").innerHTML = 
        "<p style='color:red;text-align:center;'>Error: questions.js not found or failed to load.<br>Make sure the file is named exactly <strong>questions.js</strong> and is in the same folder.</p>";
    } else {
      // Everything is ready – start the app
      const words = ["kiwi","tui","pohutukawa","manuka","kowhai","rata"];
      const secretWord = words[Math.floor(Math.random()*words.length)];
      document.getElementById("secret-word").textContent = secretWord;

      let currentData = null;
      let gradeResult = null;
      const STORAGE_KEY = "bcats_submission_2025";

      // Populate dropdowns
      TEACHERS.forEach(t => teacherSelect.add(new Option(t.name, t.id)));
      TASKS.forEach(t => taskSelect.add(new Option(t.name, t.id)));
      taskSelect.value = TASKS[0].id;   // default to first task

      function renderQuestions() {
        const task = TASKS.find(t => t.id === taskSelect.value);
        questionsContainer.innerHTML = "";
        task.questions.forEach((q, i) => {
          const block = document.createElement("div");
          block.className = "question-block";
          block.innerHTML = `
            <strong>Q${i+1} (${q.maxPoints} pts):</strong> ${q.text}<br>
            ${q.type==="long" ? '<textarea rows="5" name="q_'+q.id+'"></textarea>' : '<input type="text" name="q_'+q.id+'">'}
          `;
          questionsContainer.appendChild(block);
        });
      }

      function collectData() {
        if (authCheck.value.trim().toLowerCase() !== secretWord) {
          alert(`Secret word incorrect. It is "${secretWord}"`);
          return null;
        }
        const task = TASKS.find(t => t.id === taskSelect.value);
        const answers = task.questions.map(q => ({
          id: q.id,
          question: q.text,
          answer: document.querySelector(`[name="q_${q.id}"]`).value.trim()
        }));
        return {
          studentId: studentId.value.trim(),
          studentName: studentName.value.trim(),
          className: className.value.trim(),
          teacher: TEACHERS.find(t => t.id === teacherSelect.value),
          taskName: task.name,
          totalPoints: task.totalPoints,
          answers,
          submittedAt: new Date().toLocaleString()
        };
      }

      function autoGrade(data) {
        const task = TASKS.find(t => t.id === taskSelect.value);
        let earned = 0;
        data.answers.forEach(a => {
          const q = task.questions.find(qq => qq.id === a.id);
          if (q?.rubric) q.rubric.forEach(r => { if (r.check.test(a.answer)) earned += r.points; });
        });
        const pct = Math.round((earned / task.totalPoints) * 100);
        const letter = earned >= 90 ? "A" : earned >= 80 ? "B" : earned >= 70 ? "C" : earned >= 60 ? "D" : "F";
        return { score: `${earned}/${task.totalPoints}`, letter, pct };
      }

      async function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let y = 25;
        doc.setFontSize(18);
        doc.text(`${currentData.studentName} – ${currentData.taskName}`, 105, y, {align:"center"});
        y += 15;
        doc.setFontSize(12);
        doc.text(`ID: ${currentData.studentId} | ${currentData.submittedAt}`, 105, y, {align:"center"});
        y += 20;
        doc.setFontSize(20);
        doc.text(`GRADE: ${gradeResult.score} (${gradeResult.letter} – ${gradeResult.pct}%)`, 105, y, {align:"center"});
        y += 25;
        currentData.answers.forEach((a, i) => {
          if (y > 260) { doc.addPage(); y = 20; }
          doc.setFontSize(11);
          doc.setFont("helvetica","bold");
          doc.text(`Q${i+1}: ${a.question}`, 15, y);
          y += 8;
          doc.setFont("helvetica","normal");
          doc.splitTextToSize(a.answer || "(no answer)", 180).forEach(l => {
            if (y > 280) { doc.addPage(); y = 20; }
            doc.text(l, 20, y); y += 7;
          });
          y += 10;
        });
        return doc.output('blob');
      }

      // ----- Event Listeners -----
      taskForm.addEventListener("submit", e => {
        e.preventDefault();
        currentData = collectData();
        if (!currentData) return;
        gradeResult = autoGrade(currentData);
        localStorage.setItem(STORAGE_KEY, JSON.stringify({currentData, gradeResult}));

        summaryHeader.textContent = `${currentData.studentName} → ${currentData.teacher.name}`;
        gradeBox.innerHTML = `<strong>AUTO-GRADE:</strong> ${gradeResult.score} (${gradeResult.letter}, ${gradeResult.pct}%)`;
        summaryQuestions.innerHTML = "";
        currentData.answers.forEach((a,i) => {
          const div = document.createElement("div");
          div.className = "question-block";
          div.innerHTML = `<strong>Q${i+1}:</strong> ${a.question}<br><em>${a.answer||"(empty)"}</em>`;
          summaryQuestions.appendChild(div);
        });
        formView.classList.add("hidden");
        summaryView.classList.remove("hidden");
      });

      loadBtn.onclick = () => {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (!saved) return alert("No saved work found");
        const {currentData: d, gradeResult: g} = JSON.parse(saved);
        currentData = d; gradeResult = g;
        studentId.value = d.studentId;
        studentName.value = d.studentName;
        className.value = d.className;
        teacherSelect.value = d.teacher.id;
        taskSelect.value = TASKS.find(t => t.name === d.taskName)?.id || TASKS[0].id;
        renderQuestions();
        alert("Work loaded!");
      };

      backBtn.onclick = () => { summaryView.classList.add("hidden"); formView.classList.remove("hidden"); };
      taskSelect.onchange = renderQuestions;

      pdfBtn.onclick = async () => {
        const blob = await generatePDF();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = `${currentData.studentId}_${currentData.taskName.replace(/ /g,"_")}.pdf`;
        a.click();
      };

      async function sendEmail() {
        if (!currentData) return alert("Submit & grade first!");
        const blob = await generatePDF();
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = reader.result.split(',')[1];
          const subject = encodeURIComponent(`${currentData.studentName} - ${currentData.taskName}`);
          const body = encodeURIComponent(
            `Kia ora ${currentData.teacher.name},\n\nPlease find my completed work attached.\n\n` +
            `Auto-Grade: ${gradeResult.score} (${gradeResult.letter}, ${gradeResult.pct}%)\n` +
            `Submitted: ${currentData.submittedAt}\n\nNgā mihi,\n${currentData.studentName}`
          );
          location.href = `mailto:${currentData.teacher.email}?subject=${subject}&body=${body}&attachment=data:application/pdf;base64,${base64}`;
        };
        reader.readAsDataURL(blob);
      }
      emailBtn1.onclick = emailBtn2.onclick = sendEmail;

      // Start!
      renderQuestions();
    }
  </script>
</body>
</html>
